#! /bin/bash

USAGE='git fixup [-h] [-a] COMMIT|FILEPATH
  -a	amend the previous commit
  -h	display this message

  Create a fixup commit with the supplied id, or a fixup commit against the
  most recent change to the supplied file'

AMEND=''

while getopts 'ah' options
do
	case $options in
		a ) AMEND='--amend';;
		h ) echo "$USAGE" && exit 1;;
	esac
done
shift $((OPTIND-1))


# determine if param $1 is a file
if git cat-file -e "$1" 2>/dev/null; then
	# if not file, verify supplied git commit with rev-parse
	COMMIT_ID=$(git rev-parse "$1")

else
	# else if a file: so fixup the last non-fixup commit to the file
	COMMIT_ID=$(git log --format='%h %s' -- "$1" | awk '! /fixup!/ {print $1}' | head -1)
fi

if [[ -z $COMMIT_ID ]]; then
	echo "Unknown reference: $1"
	exit 1
fi

git commit $AMEND -m "fixup! $COMMIT_ID"
