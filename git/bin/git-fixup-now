#! /bin/bash

USAGE='git fixup-now {commit id}'

if [[ $# -eq 1 ]]; then
	# ensure something staged
	if [[ -z $(git diff --staged) ]]; then
		echo 'Nothing staged!'
		exit 1
	fi

	# stash the working tree
	#git stash --keep-index || exit 2

	# commit fixup commit
	if ! git commit -m "fixup! $1"; then
		git stash pop
		exit 2
	fi

	# rebase since target commit
	if ! git rebase -i HEAD~$(git rev-list "$1^..HEAD" | wc -l | tr -d ' '); then
		git rebase --abort
		git stash
		exit 2
	fi

	# rebase complete; pop stash to restore working tree
	git stash pop

else
	echo $USAGE
	exit 1
fi
