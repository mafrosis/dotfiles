#! /bin/bash

# reset this branch against origin maintaining working tree

USAGE='git reset-origin [-f fetch]
  -f can be supplied to fetch from remote'

FETCH=0

while getopts 'f' options
do
	case $options in
		f ) FETCH=1;;
		\? ) echo $usage
			 exit 1;;
		* ) echo $usage
			exit 1;;
	esac
done
shift $(($OPTIND-1))

function dirty {
	# adapted from prezto's git-info
	while IFS=$'\n' read line; do
		# Check for deleted, modified, renamed
		[[ "$line" == [\ ACMRT]D\ * ]] && return 0
		[[ "$line" == ?[MT]\ * ]] && return 0
		[[ "$line" == R?\ * ]] && return 0
	done < <(git status --porcelain --ignore-submodules=all)
	return 1
}

if [[ $# -eq 0 ]]; then
	# check for dirty working tree
	dirty; DIRTY=$?

	# fetch origin
	if [[ $FETCH -eq 1 ]]; then
		git fetch || exit 1
	fi

	# stash if dirty
	if [[ $DIRTY -eq 0 ]]; then
		git stash || exit 1
	fi

	# reset against remote origin
	BR=$(git symbolic-ref HEAD 2> /dev/null)
	BR=${BR#refs/heads/}
	git reset --hard origin/$BR || exit 2

	# pop stash if we were dirty
	if [[ $DIRTY -eq 0 ]]; then
		git stash pop
	fi
else
	echo $USAGE
	exit 1
fi
